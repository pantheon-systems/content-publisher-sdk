name: Tests

permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: "${{ matrix.os }}, Shell: ${{ matrix.shell }}"
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: ${{ matrix.shell }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            shell: bash
          - os: windows-latest
            shell: powershell
          - os: windows-latest
            shell: cmd
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      PCC_SITE_ID: ${{ secrets.PCC_SITE_ID }}
      PCC_TOKEN: ${{ secrets.PCC_TOKEN }}
      IS_CICD: true

    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Setup PNPM
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate Changeset Config
        run: |
          # Validate changeset configuration to catch issues before they reach the release workflow
          echo "Validating changeset configuration..."
          set +e
          OUTPUT=$(pnpm pnpm changeset status 2>&1)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            if echo "$OUTPUT" | grep -q "ValidationError"; then
              echo "❌ Changeset config validation failed!"
              echo ""
              echo "Error output:"
              echo "$OUTPUT"
              exit 1
            else
              # Other errors (like missing NPM_TOKEN or no changesets to publish) are expected
              echo "✓ Changeset config validation passed"
            fi
          else
            echo "✓ Changeset config validation passed"
          fi

      - name: Build All Packages
        run: pnpm build

      - name: Build CLI for testing
        run: pnpm --filter '*cli*' build:test

      - name: Test
        run: pnpm test

  test-pcc-init:
    name: Test pcc init - ${{ matrix.package_manager.name }} ${{ matrix.features.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package_manager:
          - flag: ""
            name: "npm (default)"
          - flag: "--use-npm"
            name: "npm"
          - flag: "--use-pnpm"
            name: "pnpm"
          - flag: "--use-yarn"
            name: "yarn"
        features:
          - flags: ""
            name: "default"
          - flags: "--eslint"
            name: "eslint"
          - flags: "--ts"
            name: "typescript"
          - flags: "--ts --appRouter"
            name: "typescript-approuter"
          - flags: "--eslint --ts"
            name: "eslint-typescript"
          - flags: "--eslint --ts --appRouter"
            name: "eslint-typescript-approuter"
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      PCC_SITE_ID: ${{ secrets.PCC_SITE_ID }}
      PCC_TOKEN: ${{ secrets.PCC_TOKEN }}
      IS_CICD: true

    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Setup PNPM
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install yarn
        run: npm install -g yarn

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build All Packages
        run: pnpm build

      - name: Build CLI for testing
        run: pnpm --filter '*cli*' build:test

      - name: Test pcc init
        run: |
          # Explicitly mask secrets to prevent accidental exposure in logs
          echo "::add-mask::$PCC_SITE_ID"
          echo "::add-mask::$PCC_TOKEN"

          # Get a unique temp directory name without creating it (init command requires directory to not exist)
          TEST_DIR=$(mktemp -u)
          # Clean up directory if it exists from a previous failed run
          rm -rf "$TEST_DIR"

          # Build the init command with package manager and feature flags
          INIT_CMD="node packages/cli/dist/index.js init $TEST_DIR --template=nextjs --non-interactive --site-id=\"$PCC_SITE_ID\" --git-ref=\"${{ github.sha }}\""

          if [ -n "${{ matrix.package_manager.flag }}" ]; then
            INIT_CMD="$INIT_CMD ${{ matrix.package_manager.flag }}"
          fi

          if [ -n "${{ matrix.features.flags }}" ]; then
            INIT_CMD="$INIT_CMD ${{ matrix.features.flags }}"
          fi

          # Execute the init command
          eval $INIT_CMD
          cd $TEST_DIR

          # Write PCC_TOKEN to .env.local file (using printf to avoid shell expansion in logs)
          printf "PCC_TOKEN=%s\n" "$PCC_TOKEN" >> .env.local

          # Verify packages are installed
          if [ ! -d "node_modules" ]; then
            echo "Error: node_modules directory not found"
            exit 1
          fi

          # Build the project to verify it works
          # Determine which package manager to use for build based on the flag used
          PM_FLAG="${{ matrix.package_manager.flag }}"
          if [[ "$PM_FLAG" == *"pnpm"* ]]; then
            pnpm build
          elif [[ "$PM_FLAG" == *"yarn"* ]]; then
            yarn build
          else
            npm run build
          fi
